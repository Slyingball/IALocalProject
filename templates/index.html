<!DOCTYPE html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-IA Locale</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-shell">
        <aside class="sidebar">
            <div class="brand">
                <div class="logo-circle">IA</div>
                <div>
                    <div class="brand-name">Multi-IA Locale</div>
                    <div class="brand-sub">Propulse par Ollama + Flask</div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">Modeles disponibles</div>
                <div class="model-list">
                    {% for key, info in models.items() %}
                    <button class="model-pill" data-model="{{ key }}" onclick="selectModel('{{ key }}')">
                        <div class="pill-main">
                            <span class="pill-badge">{{ info.icon }}</span>
                            <div>
                                <div class="pill-name">{{ info.name }}</div>
                                <div class="pill-desc">{{ info.description }}</div>
                            </div>
                        </div>
                        <span class="pill-check">âœ“</span>
                    </button>
                    {% endfor %}
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">Options</div>
                <label class="row toggle-row">
                    <input type="checkbox" id="useContext" checked>
                    <span>Utiliser le contexte de conversation</span>
                </label>
                <label class="row select-row">
                    <span>Mode systeme</span>
                    <select id="systemMode">
                        <option value="general">General</option>
                        <option value="cybersecurity">Cybersecurite</option>
                    </select>
                </label>
            </div>

            <div class="panel commands-panel">
                <div class="panel-title">Commandes disponibles</div>
                <table class="commands-table">
                    <thead>
                        <tr>
                            <th>Commande</th>
                            <th>Description</th>
                            <th>Exemple</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Scan rapide</td>
                            <td>Ports precis avec scan rapide (-F)</td>
                            <td>192.168.0.10 ports 22,80</td>
                        </tr>
                        <tr>
                            <td>Scan versions</td>
                            <td>Detection services (-sV)</td>
                            <td>scanme.nmap.org ports 80,443 sV</td>
                        </tr>
                        <tr>
                            <td>Scan complet</td>
                            <td>Plage large sans ping</td>
                            <td>192.168.0.10 ports 1-1024 no-ping</td>
                        </tr>
                        <tr>
                            <td>Historique</td>
                            <td>Effacer ou recharger</td>
                            <td>Boutons Effacer/Recharge</td>
                        </tr>
                        <tr>
                            <td>API</td>
                            <td>Appel POST /ask en JSON</td>
                            <td>{model, question, use_context}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="panel actions-panel">
                <button type="button" class="ghost-btn" onclick="clearHistory()">
                    Effacer historique modele
                </button>
                <button type="button" class="ghost-btn" onclick="clearAllHistories()">
                    Effacer tout l'historique
                </button>
            </div>
        </aside>

        <main class="chat-pane">
            <div class="chat-header">
                <div>
                    <div class="chat-kicker">Conversation active</div>
                    <div class="chat-title">Bonjour ðŸ˜’</div>
                </div>
                <div class="chip" id="activeModelLabel">Modele: -</div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="welcome-block">
                    <div class="welcome-title">Bienvenue</div>
                    <div class="welcome-sub">Choisissez un modele et posez votre premiere question.</div>
                </div>
            </div>

            <form id="askForm" class="input-dock">
                <textarea id="question" rows="2" placeholder="Saisissez votre requete... (Ctrl+Enter pour envoyer)" required></textarea>
                <div class="dock-actions">
                    <button type="button" class="ghost-btn" onclick="clearHistory()">Effacer historique</button>
                    <button type="submit" class="send-btn" id="submitBtn">
                        <span class="send-label">Envoyer</span>
                        <span class="loading" style="display:none;">â—Œ</span>
                    </button>
                </div>
            </form>
        </main>
    </div>
    <script>
        let currentModel = 'llama3';

        document.addEventListener('DOMContentLoaded', () => {
            selectModel(currentModel);
        });
        function selectModel(modelKey) {
            currentModel = modelKey;

            document.querySelectorAll('.model-pill').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.model === modelKey);
            });

            const label = document.getElementById('activeModelLabel');
            const activeButton = document.querySelector(`[data-model="${modelKey}"] .pill-name`);
            label.textContent = activeButton ? `Modele: ${activeButton.textContent}` : `Modele: ${modelKey}`;

            loadHistory(modelKey);
        }
        async function loadHistory(modelKey) {
            try {
                const response = await fetch(`/history/${modelKey}`);
                const data = await response.json();
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = '';

                if (data.history && data.history.length > 0) {
                    data.history.forEach(item => {
                        addMessage(item.question, 'user', false);
                        addMessage(item.answer, 'ai', false);
                    });
                } else {
                    chatContainer.innerHTML = `
                        <div class="welcome-block">
                            <div class="welcome-title">${data.model}</div>
                            <div class="welcome-sub">Aucun historique. Commencez une nouvelle conversation.</div>
                        </div>`;
                }
            } catch (error) {
                console.error('Erreur lors du chargement de l\'historique:', error);
            }
        }
        function addMessage(text, type, scroll = true) {
            const chatContainer = document.getElementById('chatContainer');
            const welcome = chatContainer.querySelector('.welcome-block');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = type === 'user' ? 'U' : 'IA';

            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            chatContainer.appendChild(messageDiv);

            if (scroll) {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
        }
        function showError(message) {
            const chatContainer = document.getElementById('chatContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message error-message';
            errorDiv.innerHTML = `
                <div class="avatar">!</div>
                <div class="message-content">${message}</div>
            `;
            chatContainer.appendChild(errorDiv);
            errorDiv.scrollIntoView({ behavior: 'smooth' });
        }
        document.getElementById('askForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = document.getElementById('question').value.trim();
            if (!question) return;

            const useContext = document.getElementById('useContext').checked;
            const systemMode = document.getElementById('systemMode').value;
            const submitBtn = document.getElementById('submitBtn');

            submitBtn.disabled = true;
            submitBtn.querySelector('.send-label').style.display = 'none';
            submitBtn.querySelector('.loading').style.display = 'inline';

            addMessage(question, 'user');
            document.getElementById('question').value = '';

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: currentModel,
                        question: question,
                        use_context: useContext,
                        system_mode: systemMode
                    })
                });

                const data = await response.json();
                if (data.error) {
                    showError(`Erreur: ${data.error}`);
                } else {
                    addMessage(data.answer, 'ai');
                }
            } catch (error) {
                showError(`Erreur de connexion: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.querySelector('.send-label').style.display = 'inline';
                submitBtn.querySelector('.loading').style.display = 'none';
                document.getElementById('question').focus();
            }
        });
        async function clearHistory() {
            if (!confirm(`Voulez-vous effacer l'historique de ${currentModel} ?`)) {
                return;
            }
            try {
                await fetch('/clear_history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: currentModel })
                });
                loadHistory(currentModel);
            } catch (error) {
                showError('Erreur lors de l\'effacement de l\'historique');
            }
        }

        async function clearAllHistories() {
            if (!confirm("Effacer l'historique de tous les modeles ?")) {
                return;
            }
            try {
                await fetch('/clear_history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: "all" })
                });
                loadHistory(currentModel);
            } catch (error) {
                showError('Erreur lors de l\'effacement global');
            }
        }

        document.getElementById('question').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('askForm').dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>

