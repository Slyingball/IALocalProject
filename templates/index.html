<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Interface Multi-IA Locale</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ Multi-IA Locale</h1>
            <p class="subtitle">Propuls√© par Ollama + Flask</p>
        </header>
        <!-- S√©lecteur de mod√®les style Claude -->
        <div class="model-selector">
            <div class="model-label">Mod√®le IA :</div>
            <div class="model-options">
                {% for key, info in models.items() %}
                <button class="model-btn" data-model="{{ key }}" onclick="selectModel('{{ key }}')">
                    <span class="model-icon">{{ info.icon }}</span>
                    <div class="model-info">
                        <div class="model-name">{{ info.name }}</div>
                        <div class="model-desc">{{ info.description }}</div>
                    </div>
                    <span class="checkmark">‚úì</span>
                </button>
                {% endfor %}
            </div>
        </div>
        <!-- Options avanc√©es -->
        <div class="options-panel">
            <label class="toggle-option">
                <input type="checkbox" id="useContext" checked>
                <span>Utiliser le contexte de conversation</span>
            </label>
            <label class="select-option">
                <span>Mode syst√®me :</span>
                <select id="systemMode">
                    <option value="general">G√©n√©ral</option>
                    <option value="cybersecurity">Cybers√©curit√© Expert</option>
                </select>
            </label>
        </div>
        <!-- Zone de conversation -->
        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <h2>üëã Bienvenue !</h2>
                <p>S√©lectionnez un mod√®le et commencez √† poser vos questions.</p>
            </div>
        </div>

        <!-- Ex√©cution distante de commandes whitelistees -->
        <section class="executor-card">
            <div class="executor-header">
                <div>
                    <h2>üöÄ Ex√©cuter une commande sur une cible</h2>
                    <p class="executor-subtitle">Utilise l'API s√©curis√©e /api/execute_command pour lancer un nmap, ping, etc.</p>
                </div>
                <span class="badge">Whitelist : nmap, ping, ip, df, ps, netstat, curl, ss, lsof, top</span>
            </div>
            <div class="executor-grid">
                <label class="field">
                    <span>Cible (IP ou hostname)</span>
                    <input id="targetHost" type="text" placeholder="192.168.1.10" required>
                </label>
                <label class="field">
                    <span>Commande autoris√©e</span>
                    <input id="remoteCommand" type="text" placeholder="nmap -oX -p 22,80 192.168.1.10" required>
                </label>
                <label class="field">
                    <span>Utilisateur SSH (optionnel si REMOTE_SSH_USERNAME d√©fini)</span>
                    <input id="sshUser" type="text" placeholder="sysadmin">
                </label>
                <label class="field">
                    <span>Mot de passe (POC uniquement)</span>
                    <input id="sshPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </label>
                <label class="field">
                    <span>Chemin cl√© priv√©e (optionnel)</span>
                    <input id="sshKey" type="text" placeholder="/home/user/.ssh/id_rsa">
                </label>
                <label class="field">
                    <span>Port SSH</span>
                    <input id="sshPort" type="number" min="1" max="65535" placeholder="22">
                </label>
            </div>
            <div class="executor-actions">
                <button class="btn-secondary" type="button" onclick="prefillNmap()">Pr√©remplir un Nmap</button>
                <button class="btn-primary" type="button" id="execBtn" onclick="executeRemoteCommand()">
                    <span>Ex√©cuter</span>
                    <span class="loading" style="display:none;">‚è≥</span>
                </button>
            </div>
            <div class="executor-output" id="executorOutput">
                <div class="output-row">
                    <strong>Stdout</strong>
                    <pre id="stdout"></pre>
                </div>
                <div class="output-row">
                    <strong>Stderr</strong>
                    <pre id="stderr"></pre>
                </div>
                <div class="output-row">
                    <strong>Exit code</strong>
                    <span id="exitCode" class="badge muted">‚Äî</span>
                </div>
            </div>
        </section>

        <!-- Formulaire d'envoi -->
        <form id="askForm" class="input-form">
            <textarea id="question" rows="3" placeholder="Posez votre question ici..." required></textarea>
            <div class="form-actions">
                <button type="button" onclick="clearHistory()" class="btn-secondary">
                    üóëÔ∏è Effacer l'historique
                </button>
                <button type="submit" class="btn-primary" id="submitBtn">
                    <span>Envoyer</span>
                    <span class="loading" style="display:none;">‚è≥</span>
                </button>
            </div>
        </form>
    </div>
    <script>
        let currentModel = 'llama3.1';
        let messageCount = 0;
        // Initialiser le mod√®le par d√©faut
        document.addEventListener('DOMContentLoaded', () => {
            selectModel('llama3.1');
        });
        function selectModel(modelKey) {
            currentModel = modelKey;
            // Mettre √† jour l'UI
            document.querySelectorAll('.model-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-model="${modelKey}"]`).classList.add('active');
            // Charger l'historique du mod√®le
            loadHistory(modelKey);
        }
        async function loadHistory(modelKey) {
            try {
                const response = await fetch(`/history/${modelKey}`);
                const data = await response.json();
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = '';
                if (data.history && data.history.length > 0) {
                    data.history.forEach(item => {
                        addMessage(item.question, 'user', false);
                        addMessage(item.answer, 'ai', false);
                    });
                } else {
                    chatContainer.innerHTML = `
                        <div class="welcome-message">
                            <h2>üéØ ${data.model}</h2>
                            <p>Aucun historique. Commencez une nouvelle conversation !</p>
                        </div>`;
                }
            } catch (error) {
                console.error('Erreur lors du chargement de l\'historique:', error);
            }
        }
        function addMessage(text, type, scroll = true) {
            const chatContainer = document.getElementById('chatContainer');
            // Supprimer le message de bienvenue
            const welcome = chatContainer.querySelector('.welcome-message');
            if (welcome) welcome.remove();
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = type === 'user' ? 'üë§' : 'ü§ñ';
            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            chatContainer.appendChild(messageDiv);
            if (scroll) {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
        }
        function showError(message) {
            const chatContainer = document.getElementById('chatContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message error-message';
            errorDiv.innerHTML = `
                <div class="avatar">‚ö†Ô∏è</div>
                <div class="message-content">${message}</div>
            `;
            chatContainer.appendChild(errorDiv);
            errorDiv.scrollIntoView({ behavior: 'smooth' });
        }
        document.getElementById('askForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = document.getElementById('question').value.trim();
            if (!question) return;
            const useContext = document.getElementById('useContext').checked;
            const systemMode = document.getElementById('systemMode').value;
            const submitBtn = document.getElementById('submitBtn');
            // D√©sactiver le formulaire
            submitBtn.disabled = true;
            submitBtn.querySelector('span').style.display = 'none';
            submitBtn.querySelector('.loading').style.display = 'inline';
            // Afficher la question
            addMessage(question, 'user');
            document.getElementById('question').value = '';
            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: currentModel,
                        question: question,
                        use_context: useContext,
                        system_mode: systemMode
                    })
                });
                const data = await response.json();
                if (data.error) {
                    showError(`Erreur: ${data.error}`);
                } else {
                    addMessage(data.answer, 'ai');
                }
            } catch (error) {
                showError(`Erreur de connexion: ${error.message}`);
            } finally {
                // R√©activer le formulaire
                submitBtn.disabled = false;
                submitBtn.querySelector('span').style.display = 'inline';
                submitBtn.querySelector('.loading').style.display = 'none';
                document.getElementById('question').focus();
            }
        });
        async function clearHistory() {
            if (!confirm(`Voulez-vous effacer l'historique de ${currentModel} ?`)) {
                return;
            }
            try {
                await fetch('/clear_history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: currentModel })
                });
                loadHistory(currentModel);
            } catch (error) {
                showError('Erreur lors de l\'effacement de l\'historique');
            }
        }
        // Raccourci clavier Ctrl+Enter pour envoyer
        document.getElementById('question').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('askForm').dispatchEvent(new Event('submit'));
            }
        });

        async function executeRemoteCommand() {
            const execBtn = document.getElementById('execBtn');
            execBtn.disabled = true;
            execBtn.querySelector('span').style.display = 'none';
            execBtn.querySelector('.loading').style.display = 'inline';

            const payload = {
                target_ip: document.getElementById('targetHost').value.trim(),
                command: document.getElementById('remoteCommand').value.trim(),
                username: document.getElementById('sshUser').value.trim() || undefined,
                password: document.getElementById('sshPassword').value || undefined,
                key_path: document.getElementById('sshKey').value.trim() || undefined,
                port: document.getElementById('sshPort').value ? Number(document.getElementById('sshPort').value) : undefined,
            };
            try {
                const response = await fetch('/api/execute_command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.error) {
                    document.getElementById('stdout').textContent = '';
                    document.getElementById('stderr').textContent = data.error;
                    document.getElementById('exitCode').textContent = 'erreur';
                    document.getElementById('exitCode').className = 'badge danger';
                } else {
                    document.getElementById('stdout').textContent = data.stdout || '';
                    document.getElementById('stderr').textContent = data.stderr || '';
                    document.getElementById('exitCode').textContent = data.exit_code;
                    document.getElementById('exitCode').className = data.exit_code === 0 ? 'badge success' : 'badge warning';
                }
            } catch (error) {
                document.getElementById('stdout').textContent = '';
                document.getElementById('stderr').textContent = `Erreur r√©seau : ${error.message}`;
                document.getElementById('exitCode').textContent = 'erreur';
                document.getElementById('exitCode').className = 'badge danger';
            } finally {
                execBtn.disabled = false;
                execBtn.querySelector('span').style.display = 'inline';
                execBtn.querySelector('.loading').style.display = 'none';
            }
        }

        function prefillNmap() {
            const target = document.getElementById('targetHost').value.trim() || '192.168.1.10';
            document.getElementById('targetHost').value = target;
            document.getElementById('remoteCommand').value = `nmap -oX -p 22,80 ${target}`;
        }
    </script>
</body>
</html>
